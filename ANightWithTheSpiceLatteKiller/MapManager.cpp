#include <sstream>
#include "MapManager.h"
#include "ConsoleColorEnum.h"

MapManager::MapManager(PlayerMain* player, ConsolePrinter* printer) {
	_player = player;
	_printer = printer;

	_baseMap = "0000000000000000000000000000000000000000000000000000000000000000000000000000000009999999999999999990777777777777777777777777777777777700333333333333333333333330099999999999999999907777777777777777777777777777777777003333333333333333333333309999999999999999990777777777777777777777777777777777700333333333333333333333330099999999999999999900000000000007000000000000000000000000000003000000000000033300999999999999999999011111111111111111111111111111111111111111111111111111110333009999999999999999990111111111111111111111111111111111111111111111111111111103330099999999999999999901111111111111111111111111111111111111111111111111111111033300999999999999999999011111111111111111111111111111111111111111111111111111110333009999999999999999990111111111111111111111111111111111111111111111111111111103330099999999999999999901111100000000000000011111000000000000000000000000011111033300999000000000000000011111055555555555550111110222222222222222222222220111110333009990111111111111111111110555555555555551111102222222222222222222222201111103330099991111111111111111111155555555555555011111022222222222222222222222011111033300999011111111111111111111055555555555550111110222222222222200000000000111110333000000002000000000000000000555555555555501111102222222222222011111111111111103330022222222222222222222222005555555555555011111022222222222220111111111111111033300222222222222222222222220055555555555550111112222222222222221111111111111110333002222222222222222222222200555555555555501111102222222222222011111111111111103330022222222222222222222222005555555555555011111022222222222220111111111111111033300222222222222222222222220055555555555550111110222222222222200000000400000000000002222222222222222222222200555555555555501111102222222222222004444444444444444440022222222222222222222222005555555555555011111022222222222220044444444444444444400222222222222222222222220055555555555550111110222222222222200444444444444444444000000000000000000000000000000000000000000000000000000000000000000000000000000000";

	Init();
}

void MapManager::PrintMap(int colorOverrideIndex, bool excludePlayer) {
	int mapColorOverride;
	int playerColorOverride;

	// override color
	if (colorOverrideIndex > -1) {
		mapColorOverride = colorOverrideIndex;
		playerColorOverride = (excludePlayer) ? LIGHT_YELLOW : colorOverrideIndex;
	}
	else {
		mapColorOverride = DARK_GRAY;
		playerColorOverride = LIGHT_YELLOW;
	}

	// create buffer used to print whole map in one print
	vector<CHAR_INFO> buffer(_printer->Csbi.dwMaximumWindowSize.Y * _printer->Csbi.dwMaximumWindowSize.X);
	for (int i = 1; i < _map.size(); i++) {
		for (int j = 0; j < _map[i].size(); j++) {
			if (i == PlayerPosition.second && j == PlayerPosition.first) {
				CHAR_INFO& cell = buffer[i * _printer->Csbi.dwMaximumWindowSize.X + j];
				cell.Char.AsciiChar = 'o';
				cell.Attributes = _printer->MakeColor(playerColorOverride, BLACK);
			}
			else {
				CHAR_INFO& cell = buffer[i * _printer->Csbi.dwMaximumWindowSize.X + j];
				cell.Char.AsciiChar = _map[i][j];
				cell.Attributes = _printer->MakeColor(mapColorOverride, BLACK);
			}
		}
	}

	SMALL_RECT region = { 0, 0, _printer->Csbi.dwMaximumWindowSize.X - 1, _printer->Csbi.dwMaximumWindowSize.Y - 1 };
	WriteConsoleOutput(_printer->HConsoleRef, buffer.data(), { (short)_printer->Csbi.dwMaximumWindowSize.X, (short)_printer->Csbi.dwMaximumWindowSize.Y }, { 0, 0 }, &region);
}

void MapManager::TintMap(int colorIndex, int timeMiliSec, bool excludePlayer) {
	PrintMap(colorIndex, excludePlayer);
	Sleep(timeMiliSec);
}

void MapManager::Init() {

	for (int y = 0; y < 25; y++) {

		vector<char> newLine;

		for (int x = 0; x < 80; x++) {
			newLine.push_back(_baseMap[y * 80 + x]);
		}

		_map.push_back(newLine);
	}

}

char MapManager::GetChar() {
	return '.';
}